{% include "header.html" %}

<main role="main">
   <div class="jumbotron write-jumbotron">
      <div class="container">
         {% if is_edit: %}
         <h1 class="display-2">Edit Post</h1>
         {% else: %}
         <h1 class="display-2" >New Post</h1>
         {% endif %}
         <hr class="my-4">
         {% if is_edit: %}
         <p>Edit your existing post.</p>
         {% else: %}
         <p>Share your thoughts with the world.</p>
         {% endif %}
      </div>
   </div>

   {% if is_edit %}
      {% with breadcrumb_items=[{'name': 'Home', 'url': url_for('get_all_posts')}, {'name': post.title, 'url': url_for('show_post', post_id=post._id)}, {'name': 'Edit Post', 'url': '#'}] %}
         {% include "breadcrumb.html" %}
      {% endwith %}
   {% else %}
      {% with breadcrumb_items=[{'name': 'Home', 'url': url_for('get_all_posts')}, {'name': 'New Post', 'url': '#'}] %}
         {% include "breadcrumb.html" %}
      {% endwith %}
   {% endif %}
   <div class="container">
      <div class="row">
         <div class="col-lg-8 col-md-10 mx-auto">
            <!-- Custom form rendering to add browse button for image URL -->
            <form method="POST" enctype="multipart/form-data">
               {{ form.hidden_tag() }}
               
               <div class="form-group">
                  {{ form.title.label(class="form-control-label") }}
                  {{ form.title(class="form-control") }}
               </div>
               
               <div class="form-group">
                  {{ form.subtitle.label(class="form-control-label") }}
                  {{ form.subtitle(class="form-control") }}
               </div>
               
               <div class="form-group">
                  {{ form.img_url.label(class="form-control-label") }}
                  <div class="input-group">
                     {{ form.img_url(class="form-control") }}
                     <div class="input-group-append">
                        <button class="btn btn-outline-secondary image-browse-btn" type="button" id="browseCoverImage">
                           <i class="fa fa-folder"></i> Browse
                        </button>
                     </div>
                  </div>
               </div>
               
               <div class="form-group">
                  {{ form.body.label(class="form-control-label") }}
                  {{ form.body(class="form-control", rows="10") }}
               </div>
               
               <div class="form-group">
                  {{ form.submit(class="btn btn-success") }}
               </div>
            </form>
         </div>
      </div>
   </div>
</main>

<!-- File Browser Modal -->
<div class="modal fade" id="imageBrowserModal" tabindex="-1" role="dialog">
   <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title">Select an Image</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal">
            </button>
         </div>
         <div class="modal-body">
            <div id="imageBrowserContent">
               <div class="text-center">
                  <div class="spinner-border" role="status">
                     <span class="sr-only">Loading...</span>
                  </div>
               </div>
            </div>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
         </div>
      </div>
   </div>
</div>

<style>
/* Custom CSS for image browse button alignment */
.image-browse-btn {
    height: calc(2.25rem + 2px) !important;
    padding-top: 0.375rem !important;
    padding-bottom: 0.375rem !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle browse cover image button
    document.getElementById('browseCoverImage').addEventListener('click', function() {
        // Set flag to indicate we're selecting a cover image
        window.selectingCoverImage = true;
        
        // Load images and show modal
        loadImagesAndShowModal();
    });
    
    // Initialize EasyMDE for post content
    if (document.getElementById('body')) {
        var simplemde = new EasyMDE({
            element: document.getElementById('body'),
            autosave: {
                enabled: true,
                uniqueId: "{{ 'body_' + post._id|string if is_edit else 'new_post_body' }}",
                delay: 1000,
            },
            forceSync: true,
            spellChecker: false,
            previewRender: function(plainText) {
                // Simple markdown rendering without async operations
                var rendered = this.parent.markdown(plainText);
                // Apply syntax highlighting after a short delay to ensure DOM is updated
                setTimeout(function() {
                    hljs.highlightAll();
                }, 10);
                return rendered;
            },
            toolbar: [
                "bold", "italic", "heading", "|",
                "quote", "unordered-list", "ordered-list", "|",
                "link", "image", "table", "|",
                "preview", "side-by-side", "fullscreen", "|",
                {
                    name: "upload",
                    action: function customFunction(editor) {
                        // Create file input
                        var fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';
                        
                        fileInput.onchange = function(e) {
                            var file = e.target.files[0];
                            if (file) {
                                var formData = new FormData();
                                formData.append('file', file);
                                
                                // Upload file
                                fetch('/upload', {
                                    method: 'POST',
                                    body: formData
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.data && data.data.filePath) {
                                        // Insert image into editor
                                        var cm = editor.codemirror;
                                        var output = '![' + file.name + '](' + data.data.filePath + ')';
                                        var cursor = cm.getCursor();
                                        cm.replaceSelection(output);
                                    } else {
                                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    alert('Upload failed: ' + error.message);
                                });
                            }
                        };
                        
                        fileInput.click();
                    },
                    className: "fa fa-upload",
                    title: "Upload Image",
                },
                {
                    name: "browse",
                    action: function customFunction(editor) {
                        // Store reference to editor for later use
                        window.currentEditor = editor;
                        window.selectingCoverImage = false;
                        
                        // Load images and show modal
                        loadImagesAndShowModal();
                    },
                    className: "fa fa-folder",
                    title: "Browse Images",
                }
            ]
        });
    }
    
    // Initialize EasyMDE for comment content (if present)
    if (document.getElementById('comment_text')) {
        var commentMde = new EasyMDE({
            element: document.getElementById('comment_text'),
            spellChecker: false,
            previewRender: function(plainText) {
                // Simple markdown rendering without async operations
                var rendered = this.parent.markdown(plainText);
                // Apply syntax highlighting after a short delay to ensure DOM is updated
                setTimeout(function() {
                    hljs.highlightAll();
                }, 10);
                return rendered;
            },
            toolbar: [
                "bold", "italic", "heading", "|",
                "quote", "unordered-list", "ordered-list", "|",
                "link", "image", "|",
                "preview", "|",
                {
                    name: "upload",
                    action: function customFunction(editor) {
                        // Create file input
                        var fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';
                        
                        fileInput.onchange = function(e) {
                            var file = e.target.files[0];
                            if (file) {
                                var formData = new FormData();
                                formData.append('file', file);
                                
                                // Upload file
                                fetch('/upload', {
                                    method: 'POST',
                                    body: formData
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.data && data.data.filePath) {
                                        // Insert image into editor
                                        var cm = editor.codemirror;
                                        var output = '![' + file.name + '](' + data.data.filePath + ')';
                                        var cursor = cm.getCursor();
                                        cm.replaceSelection(output);
                                    } else {
                                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    alert('Upload failed: ' + error.message);
                                });
                            }
                        };
                        
                        fileInput.click();
                    },
                    className: "fa fa-upload",
                    title: "Upload Image",
                },
                {
                    name: "browse",
                    action: function customFunction(editor) {
                        // Store reference to editor for later use
                        window.currentEditor = editor;
                        window.selectingCoverImage = false;
                        
                        // Load images and show modal
                        loadImagesAndShowModal();
                    },
                    className: "fa fa-folder",
                    title: "Browse Images",
                }
            ]
        });
    }
    
    // Function to load images and show modal
    function loadImagesAndShowModal() {
        // Show loading indicator
        document.getElementById('imageBrowserContent').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        `;
        
        // Show modal using Bootstrap 5 JavaScript
        var modal = new bootstrap.Modal(document.getElementById('imageBrowserModal'));
        modal.show();
        
        // Load images from API
        fetch('/api/images')
        .then(response => response.json())
        .then(data => {
            if (data.images && data.images.length > 0) {
                // Create image grid
                let html = '<div class="row">';
                data.images.forEach(image => {
                    html += `
                        <div class="col-md-3 mb-3">
                            <div class="card image-browser-item" style="cursor: pointer;" 
                                 onclick="selectImage('${image.url}', '${image.name}')">
                                <img src="${image.url}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="${image.name}">
                                <div class="card-body p-2">
                                    <p class="card-text small text-truncate mb-0">${image.name}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('imageBrowserContent').innerHTML = html;
            } else {
                document.getElementById('imageBrowserContent').innerHTML = '<p class="text-center">No images uploaded yet.</p>';
            }
        })
        .catch(error => {
            document.getElementById('imageBrowserContent').innerHTML = '<p class="text-center text-danger">Failed to load images.</p>';
            console.error('Error loading images:', error);
        });
    }
    
    // Function to select an image
    window.selectImage = function(url, name) {
        // Close modal using Bootstrap 5 JavaScript
        var modal = bootstrap.Modal.getInstance(document.getElementById('imageBrowserModal'));
        if (modal) {
            modal.hide();
        }
        
        // Check if we're selecting a cover image or inserting into editor
        if (window.selectingCoverImage) {
            // Set the cover image URL in the form field
            document.getElementById('img_url').value = url;
            window.selectingCoverImage = false;
        } else if (window.currentEditor) {
            // Insert image into editor
            var cm = window.currentEditor.codemirror;
            var output = '![' + name + '](' + url + ')';
            var cursor = cm.getCursor();
            cm.replaceSelection(output);
        }
    };
});
</script>

<br>
<hr>
{% include "footer.html" %}