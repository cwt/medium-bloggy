{% import "bootstrap/wtf.html" as wtf %}
<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- META TAGS -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <meta name="description" content="{{ post.subtitle }} - Posted by {{ post.author }} on {{ post.date }}">
      <meta name="author" content="{{ post.author }}">
      
      <!-- Open Graph / Facebook -->
      <meta property="og:type" content="article">
      <meta property="og:url" content="{{ request.url }}">
      <meta property="og:title" content="{{ post.title }}">
      <meta property="og:description" content="{{ post.subtitle }} - Posted by {{ post.author }} on {{ post.date }}">
      <meta property="og:image" content="{{ post.img_url }}">
      
      <!-- Twitter -->
      <meta property="twitter:card" content="summary_large_image">
      <meta property="twitter:url" content="{{ request.url }}">
      <meta property="twitter:title" content="{{ post.title }}">
      <meta property="twitter:description" content="{{ post.subtitle }} - Posted by {{ post.author }} on {{ post.date }}">
      <meta property="twitter:image" content="{{ post.img_url }}">

      <!-- TITLE | FAVICON -->
      <title>{{ post.title }} - Medium Bloggy</title>
      <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.jpg')}}">
      
      <!-- Canonical URL -->
      <link rel="canonical" href="{{ request.url }}">

       <!-- CSS -->
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
         integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous"/>
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"
         integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">

       <!-- CUSTOM STYLE -->
      <link href="{{ url_for('static', filename='css/style.css')}}" rel="stylesheet">
   </head>
   <body>

      <!-- NAVIGATION -->
      <header>
         <nav class="navbar navbar-expand-md navbar-light fixed-top bg-light">
            <a class="navbar-brand mb-0 h1" href="{{url_for('get_all_posts')}}"><img src="/static/img/logo.png" alt=""
               loading="lazy"></a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
               data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
               aria-label="Toggle navigation"><i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
               <ul class="navbar-nav ml-auto">
                  <form class="form-inline my-2 my-lg-0" action="{{ url_for('search') }}" method="POST">
                     <input class="form-control mr-sm-2 search-button-margin" type="search" name="query" placeholder="Search all posts..." value="{{ search_query or '' }}"
                        aria-label="Search">
                     <button class="btn btn-dark ml-1" type="submit">Search</button>
                     <a class="btn btn-outline-info ml-1" href="{{ url_for('get_all_posts') }}"
                        role="button">Reset</a>
                  </form>
                  {% if not session.user %}
                  <li class="nav-item">
                     <a class="nav-link" href="{{ url_for('login') }}">Sign In</a>
                     <span class="sr-only">(current)</span>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="{{ url_for('register') }}">Get Started</a>
                     <span class="sr-only">(current)</span>
                  </li>
                  {% else: %}
                  <li class="nav-item">
                     <a class="nav-link" href="{{ url_for('create_post') }}">Write</a>
                     <span class="sr-only">(current)</span>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="{{ url_for('upload_image') }}">Upload Image</a>
                     <span class="sr-only">(current)</span>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="{{ url_for('logout') }}">Log Out</a>
                     <span class="sr-only">(current)</span>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="{{ url_for('profile', username=session['user']) }}">Profile</a>
                     <span class="sr-only">(current)</span>
                  </li>
                  {% endif %}
               </ul>
            </div>
         </nav>
      </header>
<!-- PAGE HEADER -->
<header class="masthead" style="background-image: url('{{ post.img_url }}')">
   <div class="overlay"></div>
   <div class="container">
      <div class="row">
         <div class="col-lg-8 col-md-10 mx-auto">
            <div class="post-heading">
               <h1>{{ post.title }}</h1>
               <h2 class="subheading">{{ post.subtitle }}</h2>
               <span class="meta">Posted by {{ post.author }} on {{ post.date }}</span>
            </div>
         </div>
      </div>
   </div>
</header>

<!-- POST CONTENT -->
<article>
   <div class="container">
      <div class="row">
         <div class="col-lg-8 col-md-10 mx-auto">
            {{ post.body|markdown|safe }}
            <hr>
            {% if session.user == post.author %}
            <div class="clearfix mb-5">
               <button type="button" class="btn btn-outline-danger float-right" data-toggle="modal"
                  data-target="#delete{{ post._id }}">
               Delete Post
               </button>
               <!-- Modal -->
               <div class="modal fade" id="delete{{ post._id }}" tabindex="-1" role="dialog"
                  aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                     <div class="modal-content">
                        <div class="modal-header">
                           <h5 class="modal-title" id="exampleModalLongTitle">Are you sure you want to
                              delete this post?
                           </h5>
                           <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                           <span aria-hidden="true">&times;</span>
                           </button>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-secondary" data-dismiss="modal">Close
                           </button>
                           <a class="btn btn-outline-danger btn-sm"
                              href="{{ url_for('delete_post', post_id=post._id) }}">Delete Post
                           </a>
                        </div>
                     </div>
                  </div>
               </div>
               <a class="btn btn-outline-secondary float-left"
                  href="{{ url_for('edit_post', post_id=post._id) }}">Edit Post</a>
            </div>
            {% endif %}

            <!-- COMMENTS AREA -->
            {% if session.user %}
            {{ wtf.quick_form(form, novalidate=True, button_map={"submit": "success"}) }}
            {% endif %}
            <div class="col-lg-8 col-md-10 mx-auto comment">
               {% for comment in comments: %}
               <ul class="commentList">
                  <li>
                     <div class="commenterImage">
                        <i class="far fa-user"></i>
                     </div>
                     <div class="commentText">
                        {{comment.text|markdown|safe}}
                        <span class="date sub-text">Posted by {{comment.comment_author}}</span>
                        {% if session.user == comment.comment_author %}
                        <button type="button" class="btn btn-outline-danger" data-toggle="modal"
                           data-target="#deletecomment{{ comment._id }}">
                        Delete Comment
                        </button>

                        <!-- MODAL -->
                        <div class="modal fade" id="deletecomment{{ comment._id }}" tabindex="-1" role="dialog"
                           aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                           <div class="modal-dialog modal-dialog-centered" role="document">
                              <div class="modal-content">
                                 <div class="modal-header">
                                    <h5 class="modal-title" id="exampModalLongTitle">Are you sure you want
                                       to
                                       delete this comment?
                                    </h5>
                                    <button type="button" class="close" data-dismiss="modal"
                                       aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                    </button>
                                 </div>
                                 <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                    Close
                                    </button>
                                    <a class="btn btn-outline-danger"
                                       href="{{ url_for('delete_comment', comment_id=comment._id, post_id=post._id) }}">Delete
                                    Comment
                                    </a>
                                 </div>
                              </div>
                           </div>
                        </div>
                        {% endif %}
                     </div>
                  </li>
               </ul>
               {% endfor %}
            </div>
         </div>
      </div>
   </div>
</article>

<!-- File Browser Modal -->
<div class="modal fade" id="imageBrowserModal" tabindex="-1" role="dialog">
   <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title">Select an Image</h5>
            <button type="button" class="close" data-dismiss="modal">
               <span>&times;</span>
            </button>
         </div>
         <div class="modal-body">
            <div id="imageBrowserContent">
               <div class="text-center">
                  <div class="spinner-border" role="status">
                     <span class="sr-only">Loading...</span>
                  </div>
               </div>
            </div>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
         </div>
      </div>
   </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize SimpleMDE for comment content
    if (document.getElementById('comment_text')) {
        var simplemde = new SimpleMDE({
            element: document.getElementById('comment_text'),
            toolbar: [
                "bold", "italic", "heading", "|",
                "quote", "unordered-list", "ordered-list", "|",
                "link", "image", "|",
                "preview", "|",
                {
                    name: "upload",
                    action: function customFunction(editor) {
                        // Create file input
                        var fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';
                        
                        fileInput.onchange = function(e) {
                            var file = e.target.files[0];
                            if (file) {
                                var formData = new FormData();
                                formData.append('file', file);
                                
                                // Upload file
                                fetch('/upload', {
                                    method: 'POST',
                                    body: formData
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.data && data.data.filePath) {
                                        // Insert image into editor
                                        var cm = editor.codemirror;
                                        var output = '![' + file.name + '](' + data.data.filePath + ')';
                                        var cursor = cm.getCursor();
                                        cm.replaceSelection(output);
                                    } else {
                                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    alert('Upload failed: ' + error.message);
                                });
                            }
                        };
                        
                        fileInput.click();
                    },
                    className: "fa fa-upload",
                    title: "Upload Image",
                },
                {
                    name: "browse",
                    action: function customFunction(editor) {
                        // Store reference to editor for later use
                        window.currentEditor = editor;
                        
                        // Load images and show modal
                        loadImagesAndShowModal();
                    },
                    className: "fa fa-folder",
                    title: "Browse Images",
                }
            ]
        });
    }
    
    // Function to load images and show modal
    function loadImagesAndShowModal() {
        // Show loading indicator
        document.getElementById('imageBrowserContent').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        `;
        
        // Show modal
        $('#imageBrowserModal').modal('show');
        
        // Load images from API
        fetch('/api/images')
        .then(response => response.json())
        .then(data => {
            if (data.images && data.images.length > 0) {
                // Create image grid
                let html = '<div class="row">';
                data.images.forEach(image => {
                    html += `
                        <div class="col-md-3 mb-3">
                            <div class="card image-browser-item" style="cursor: pointer;" 
                                 onclick="selectImage('${image.url}', '${image.name}')">
                                <img src="${image.url}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="${image.name}">
                                <div class="card-body p-2">
                                    <p class="card-text small text-truncate mb-0">${image.name}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('imageBrowserContent').innerHTML = html;
            } else {
                document.getElementById('imageBrowserContent').innerHTML = '<p class="text-center">No images uploaded yet.</p>';
            }
        })
        .catch(error => {
            document.getElementById('imageBrowserContent').innerHTML = '<p class="text-center text-danger">Failed to load images.</p>';
            console.error('Error loading images:', error);
        });
    }
    
    // Function to select an image
    window.selectImage = function(url, name) {
        // Close modal
        $('#imageBrowserModal').modal('hide');
        
        // Insert image into editor if we have a reference
        if (window.currentEditor) {
            var cm = window.currentEditor.codemirror;
            var output = '![' + name + '](' + url + ')';
            var cursor = cm.getCursor();
            cm.replaceSelection(output);
        }
    };
});
</script>

<br>
<hr>
<!-- FOOTER -->
<footer>
   <div class="container">
      <div class="row">
         <div class="col-lg-8 col-md-10 mx-auto">
            <ul class="list-inline text-center">
               <li class="list-inline-item">
                  <a href="https://twitter.com/">
                  <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                  </a>
               </li>
               <li class="list-inline-item">
                  <a href="https://www.facebook.com/">
                  <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                  </span>
                  </a>
               </li>
               <li class="list-inline-item">
                  <a href="https://github.com/">
                  <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                  </a>
               </li>
            </ul>
            <!-- Quote -->
            <div class="quote-text text-center mt-5">
            <i class="fas fa-quote-left"></i>
            <span id="quote" class="quote-text"></span><span id="author" class="quote-author"></span>
            </div>
            <p class="copyright text-muted">
               Copyright &copy; Medium Bloggy <script>document.write(new Date().getFullYear());</script>
               | <a href="/sitemap.xml">Sitemap</a>
            </p>
         </div>
      </div>
   </div>
</footer>
<!-- JQUERY, POPPER.JS, BOOTSTRAP.JS-->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
   integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
   integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
   integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <!-- Custom script for random quote generation -->
  <script src="{{ url_for('static', filename='js/script.js')}}"></script>
</body>
</html>